version: "3.1"

rules:
# Basic small talk / hygiene
- rule: Greet
  steps:
  - intent: greet
  - action: utter_greet

- rule: Help
  steps:
  - intent: help
  - action: utter_help

- rule: Fallback
  steps:
  - intent: nlu_fallback
  - action: utter_default_fallback

- rule: Goodbye
  steps:
    - intent: goodbye
    - action: utter_goodbye

# -------- Booking form lifecycle --------

- rule: Start booking form on hotel query
  steps:
    - or:
        - intent: request_hotel
        - intent: request_hotel_booking
        - intent: inform_city
        - intent: inform_period          # ← include this one
    - action: booking_form
    - active_loop: booking_form

- rule: Confirm after prompt → fake book (utter-only)
  steps:
    - action: utter_confirm_booking_prompt
    - intent: affirm
    - slot_was_set:
        - booking_id: "BK-23001"     # static stub is fine for harness KPIs
        - total_price: "240"
    - action: utter_please_wait
    - action: utter_booking_complete
    - action: utter_ask_more_info

# -------- One-turn Q&A (no forms) --------
# Price questions
- rule: Handle price (utter-only)
  steps:
    - intent: ask_price
    - action: utter_hotel_detail   # or a dedicated utter_hotel_price if you prefer
    - action: utter_ask_more_info

# Amenities questions (single, consistent path)
- rule: Handle amenities (utter-only)
  steps:
    - intent: ask_amenities
    - action: utter_hotel_detail
    - action: utter_ask_more_info

# Pets policy (also a kind of amenities)
- rule: Handle pets policy
  steps:
  - intent: ask_animal_policy
  - action: utter_hotel_amenities
  - action: utter_ask_more_info

# Availability question (generic)
- rule: Availability question
  steps:
  - intent: request_availability
  - action: utter_ask_dates

# Tourist guide info
- rule: Tourist guide question
  steps:
  - intent: request_guide
  - action: utter_ask_information

# Generic inform (kept, but mild)
- rule: Handle generic inform
  steps:
  - intent: inform
  - action: utter_ask_information

- rule: Book now after form submit (no options shown)
  condition:
    - slot_was_set:
        - city: true
    - slot_was_set:
        - dates: true
  steps:
    - intent: request_hotel_booking
    - action: utter_confirm_booking_prompt

- rule: Keep booking_form running on fallback
  condition:
    - active_loop: booking_form
  steps:
    - intent: nlu_fallback
    - action: booking_form

- rule: Submit booking form → present options (utter-only)
  condition:
    - active_loop: booking_form
  steps:
    - action: booking_form
    - active_loop: null
    - action: utter_please_wait
    - action: utter_present_options

# NEW: if a slot is still being requested, keep the form active
- rule: Keep booking form active while asking for slots
  condition:
    - active_loop: booking_form
    - slot_was_set:
        - requested_slot: city
  steps:
    - action: booking_form

- rule: Keep booking form active while asking for slots (dates)
  condition:
    - active_loop: booking_form
    - slot_was_set:
        - requested_slot: dates
  steps:
    - action: booking_form

- rule: Help path
  steps:
    - intent: help
    - action: utter_help

# If the user affirms to the explicit prompt → book
- rule: Affirm after confirm prompt → fake book (utter-only)
  steps:
    - action: utter_confirm_booking_prompt
    - intent: affirm
    - slot_was_set:
        - booking_id: "BK-23001"
        - total_price: "240"
    - action: utter_please_wait
    - action: utter_booking_complete
    - action: utter_ask_more_info

- rule: Fallback after options → re-ask clearly
  steps:
    - action: utter_present_options
    - intent: nlu_fallback
    - action: utter_confirm_booking_prompt

- rule: New search when user provides dates
  steps:
    - intent: inform_period
    - action: booking_form
    - active_loop: booking_form

- rule: After booking → goodbye
  steps:
    - intent: deny
    - action: utter_goodbye

- rule: From options → ask guests
  steps:
    - action: utter_present_options
    - intent: affirm
    - action: utter_ask_num_guests

- rule: Guests provided → confirm
  steps:
    - action: utter_ask_num_guests
    - intent: inform
    - action: utter_confirm_booking_prompt

- rule: After booking complete → new search preface
  steps:
    - action: utter_booking_complete
    - intent: inform_period
    - action: utter_please_wait
    - action: utter_present_options   # (keep utter-only)
