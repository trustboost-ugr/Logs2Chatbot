version: "3.1"
rules:

# Hygiene / small talk
- rule: Greet
  steps:
  - intent: greet
  - action: utter_greet

- rule: Help
  steps:
  - intent: help
  - action: utter_help

- rule: Fallback (speak)
  steps:
  - intent: nlu_fallback
  - action: utter_default_fallback

# IMPORTANT: map the action to speech (prevents silent REST replies)
- rule: Speak on fallback action
  steps:
  - action: action_default_fallback
  - action: utter_default_fallback

# Start the schedule form on first turn task intents
- rule: Start schedule form (ask or inform)
  steps:
  - or:
      - intent: request_bus_schedule
      - intent: inform            # single tokens like “lawrenceville”, “28X”, “now”
  - action: schedule_form
  - active_loop: schedule_form

# Keep asking while a slot is requested
- rule: Keep form active while asking
  condition:
    - active_loop: schedule_form
    - slot_was_set:
        - requested_slot: bus_route
  steps:
    - action: schedule_form

- rule: Keep form active while asking (departure)
  condition:
    - active_loop: schedule_form
    - slot_was_set:
        - requested_slot: departure
  steps:
    - action: schedule_form

- rule: Keep form active while asking (destination)
  condition:
    - active_loop: schedule_form
    - slot_was_set:
        - requested_slot: destination
  steps:
    - action: schedule_form

- rule: Keep form active while asking (time)
  condition:
    - active_loop: schedule_form
    - slot_was_set:
        - requested_slot: departure_time
  steps:
    - action: schedule_form

# Submit schedule form → utter-only “search”
- rule: Submit schedule form (utter-only)
  condition:
    - active_loop: schedule_form
  steps:
    - action: schedule_form
    - active_loop: null
    - action: utter_searching
    - action: utter_find_bus
    - action: utter_follow_up

# Follow-ups
- rule: Next bus
  steps:
  - intent: request_next_bus
  - action: utter_searching
  - action: utter_find_next_bus
  - action: utter_follow_up

- rule: Previous bus
  steps:
  - intent: request_previous_bus
  - action: utter_searching
  - action: utter_find_previous_bus
  - action: utter_follow_up

- rule: Keep schedule_form on fallback
  condition:
    - active_loop: schedule_form
  steps:
    - intent: nlu_fallback
    - action: schedule_form
